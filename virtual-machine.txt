resource "azurerm_network_interface" "core-vpn-01-vm-nic" {
  depends_on                        = [azurerm_resource_group.core-vm-rg]

  name                              = "${var.azure-resource-name}-core-vpn-01-vm-nic"
  location                          = var.location
  resource_group_name               = azurerm_resource_group.core-vm-rg.name
  enable_ip_forwarding              = true

  ip_configuration {
    name                            = "base-ip"
    subnet_id                       = var.vpn-snet
    private_ip_address_allocation   = "Dynamic"
  }

  tags                              = "${(local.tags)}"
}

resource "azurerm_linux_virtual_machine" "core-vpn-01-vm" {
  depends_on                        = [
                                      azurerm_resource_group.core-vm-rg,
                                      azurerm_network_interface.core-vpn-01-vm-nic
                                      ]

  name                              = "${var.azure-resource-name}-core-vpn-01-vm"
  computer_name                     = "${var.server-hostname}11-01"
  resource_group_name               = azurerm_resource_group.core-vm-rg.name
  location                          = var.location
  size                              = var.vm-size
  admin_username                    = var.vm-admin

  network_interface_ids             = [azurerm_network_interface.core-vpn-01-vm-nic.id]

  identity {
    type                            = "UserAssigned"
    identity_ids                    = ["${var.vm-managed-identity}"]
  }

  admin_ssh_key {
    username                        = var.vm-admin
    public_key                      = file("./ssh-key/id_rsa-foundry.pub")
  }

  os_disk {
    caching                         = "ReadWrite"
    storage_account_type            = "Standard_LRS"
  }

  source_image_reference {
    publisher                       = "Canonical"
    offer                           = "0001-com-ubuntu-server-focal"
    sku                             = "20_04-lts-gen2"
    version                         = "latest"
  }

  tags                              = "${(local.tags)}"
}

resource "azurerm_backup_protected_vm" "core-vpn-01-vm-rsvvm" {
  depends_on                        = [
                                      azurerm_backup_policy_vm.core-rsv-policy,
                                      azurerm_linux_virtual_machine.core-vpn-01-vm
                                      ]

  resource_group_name               = azurerm_resource_group.core-vm-rg.name
  recovery_vault_name               = azurerm_recovery_services_vault.core-rsv.name
  source_vm_id                      = azurerm_linux_virtual_machine.core-vpn-01-vm.id
  backup_policy_id                  = azurerm_backup_policy_vm.core-rsv-policy.id
}
